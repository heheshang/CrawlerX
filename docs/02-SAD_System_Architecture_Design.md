# CrawlerX 系统架构设计文档 (SAD)
## System Architecture Design

> **版本**: v1.0.0
> **日期**: 2025-12-25
> **项目代号**: CrawlerX
> **文档状态**: 正式发布

---

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | CrawlerX 系统架构设计文档 |
| **文档版本** | v2.0.0 (统一PostgreSQL存储) |
| **创建日期** | 2025-12-25 |
| **更新日期** | 2025-12-25 |
| **文档作者** | AI System Architect |
| **审核状态** | 待审核 |

---

## 1. 架构概述

### 1.1 系统定位

CrawlerX 是一个**分布式、可扩展、智能化**的视觉驱动数据提取平台，采用**微服务架构**设计，核心能力：

```
┌─────────────────────────────────────────────────────────────────┐
│                     CrawlerX Architecture                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │
│    │ 前端 UI │───▶│ API 网关│───▶│ 服务层  │───▶│ 数据层  │   │
│    │ React   │    │ Gateway │    │Service  │    │Storage  │   │
│    └─────────┘    └─────────┘    └─────────┘    └─────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 设计原则

| 原则 | 说明 | 应用场景 |
|------|------|----------|
| **分层解耦** | 按职责分层，层间通过接口交互 | 前端-网关-服务-数据 |
| **微服务化** | 按业务领域拆分服务 | 视觉识别、数据提取、任务调度 |
| **高可用性** | 无状态设计，支持水平扩展 | 所有核心服务 |
| **可观测性** | 全链路追踪、监控、告警 | 所有服务组件 |
| **安全性** | 最小权限原则，纵深防御 | 认证、授权、数据加密 |

### 1.3 技术栈选型

```
┌─────────────────────────────────────────────────────────────────┐
│                        CrawlerX 技术栈                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   前端层        │  │   后端层        │  │   基础设施      │ │
│  │                 │  │                 │  │                 │ │
│  │ • React 18      │  │ • Python 3.11   │  │ • Docker        │ │
│  │ • TypeScript    │  │ • FastAPI       │  │ • Kubernetes    │ │
│  │ • Ant Design    │  │ • Celery        │  │ • Nginx         │ │
│  │ • Fabric.js     │  │ • Selenium      │  │ • Prometheus    │ │
│  └─────────────────┘  │ • Playwright    │  │ • Grafana       │ │
│                       │ • OpenCV        │  └─────────────────┘ │
│                       └─────────────────┘                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      数据存储 (统一 PostgreSQL)          │   │
│  │                                                         │   │
│  │  • PostgreSQL 15 (核心数据库)                            │   │
│  │    - 业务数据: 用户/任务/结果/模板                        │   │
│  │    - 缓存数据: UNLOGGED表 (会话/缓存)                    │   │
│  │    - 队列数据: SKIP LOCKED (任务队列)                    │   │
│  │    - 文件数据: BYTEA + 文件系统路径                      │   │
│  │    - 日志数据: JSONB + 分区表                            │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      PostgreSQL 扩展                     │   │
│  │                                                         │   │
│  │  • uuid-ossp (UUID)  • pg_trgm (模糊搜索)                │   │
│  │  • btree_gin (复合索引)  • pg_stat_statements (监控)     │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 统一存储策略

**设计理念**: 简化架构、降低运维成本、提高数据一致性

| 原存储方案 | PostgreSQL替代方案 | 核心技术 | 性能影响 |
|------------|---------------------|----------|----------|
| Redis | UNLOGGED表 + SKIP LOCKED | 会话/缓存/队列 | 可接受 |
| MinIO | BYTEA + 文件系统路径 | 混合存储 | 无影响 |
| MongoDB | JSONB + 分区表 | 日志/文档 | 相近或更好 |

**优势**:
- 单一数据库，简化运维
- ACID事务保证数据一致性
- SQL联表查询，统一分析
- 统一备份恢复策略

---

## 2. 总体架构

### 2.1 逻辑架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CrawlerX 逻辑架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           表现层 (Presentation)                       │   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  Web UI      │  │  CLI Tool    │  │  REST API    │              │   │
│  │  │  (React)     │  │  (Python)    │  │  (OpenAPI)   │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           网关层 (Gateway)                            │   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  API Gateway │  │  Auth Nginx  │  │  Load Balance│              │   │
│  │  │  (Kong/Traefik)│ │  (OAuth2/JWT)│  │  (Round Robin)│              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           服务层 (Service)                           │   │
│  │                                                                     │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │ Vision     │ │  Data      │ │ Task       │ │ User       │       │   │
│  │  │ Service    │ │  Service   │ │ Service    │ │ Service    │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │
│  │                                                                     │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │ Extraction │ │ Scheduler  │ │ Notification│ │ Plugin     │       │   │
│  │  │ Engine     │ │ Service    │ │ Service    │ │ Service    │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              数据层 (Data) - 统一 PostgreSQL 架构                  │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    PostgreSQL 15                            │   │   │
│  │  │                                                             │   │   │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │   │   │
│  │  │  │ 业务数据表   │ │ UNLOGGED表   │ │ 分区表       │       │   │   │
│  │  │  │ (持久化存储) │ │ (会话/缓存)  │ │ (日志)       │       │   │   │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘       │   │   │
│  │  │                                                             │   │   │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │   │   │
│  │  │  │ 任务队列表   │ │ 文件存储表   │ │ JSONB表      │       │   │   │
│  │  │  │ (SKIP LOCKED)│ │ (BYTEA/路径) │ │ (文档数据)   │       │   │   │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘       │   │   │
│  │  │                                                             │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           外部层 (External)                          │   │
│  │                                                                     │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │ Browser    │ │  Target    │ │  Third     │ │  Message   │       │   │
│  │  │ Pool       │ │  Websites  │ │  Party APIs│ │  Queue     │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CrawlerX 部署架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Internet                                                                 │
│      │                                                                     │
│      ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        DMZ 区                                        │   │
│  │                                                                     │   │
│  │  ┌──────────────┐      ┌──────────────┐                            │   │
│  │  │   Nginx LB   │──────▶│   Nginx LB   │                            │   │
│  │  │  (Public IP) │      │  (Public IP) │                            │   │
│  │  └──────────────┘      └──────────────┘                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                     │                                             │
│      └──────────┬──────────┘                                             │
│                 ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      应用区 (Kubernetes)                             │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                     API Gateway Pod                          │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                         │   │   │
│  │  │  │ Gateway │ │ Gateway │ │ Gateway │  (3 replicas)           │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘                         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                  Application Pods                            │   │   │
│  │  │                                                             │   │   │
│  │  │  Vision Service     Data Service    Task Service            │   │   │
│  │  │  ┌───┐┌───┐┌───┐   ┌───┐┌───┐┌───┐  ┌───┐┌───┐┌───┐       │   │   │
│  │  │  │VS ││VS ││VS │   │DS ││DS ││DS │  │TS ││TS ││TS │       │   │   │
│  │  │  └───┘└───┘└───┘   └───┘└───┘└───┘  └───┘└───┘└───┘       │   │   │
│  │  │                                                             │   │   │
│  │  │  Extraction Engine  Scheduler Service  User Service        │   │   │
│  │  │  ┌───┐┌───┐┌───┐   ┌───┐┌───┐┌───┐  ┌───┐┌───┐┌───┐       │   │   │
│  │  │  │EE ││EE ││EE │   │SS ││SS ││SS │  │US ││US ││US │       │   │   │
│  │  │  └───┘└───┘└───┘   └───┘└───┘└───┘  └───┘└───┘└───┘       │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                   Worker Pods (Celery)                       │   │   │
│  │  │  ┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐  (弹性伸缩)                │   │   │
│  │  │  │W1 ││W2 ││W3 ││W4 ││W5 ││W6 │                            │   │   │
│  │  │  └───┘└───┘└───┘└───┘└───┘└───┘                            │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据区                                        │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    PostgreSQL 15                            │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                       │   │   │
│  │  │  │ Primary │ │ Replica │ │ Replica │  (高可用集群)           │   │   │
│  │  │  │ (读写)  │ │ (只读)  │ │ (只读)  │                       │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘                       │   │   │
│  │  │                                                             │   │   │
│  │  │  • 业务数据表  • UNLOGGED缓存表  • 分区日志表                │   │   │
│  │  │  • 任务队列表  • 文件存储表     • JSONB文档表                │   │   │
│  │  │                                                             │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心服务设计

### 3.1 Vision Service (视觉识别服务)

**职责**: 处理截图标记、坐标映射、视觉识别

```
┌─────────────────────────────────────────────────────────────────┐
│                      Vision Service                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: URL + 截图 + 标记坐标                                     │
│  输出: 映射后的DOM选择器/坐标                                    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    核心功能模块                          │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 坐标校准引擎 │  │ 标记识别引擎 │  │ 抗干扰引擎   │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • DPI适配   │  │ • 矩形框选   │  │ • 水印过滤   │  │   │
│  │  │ • 缩放转换  │  │ • 多边形     │  │ • 噪点去除   │  │   │
│  │  │ • 视口映射  │  │ • 点标记     │  │ • 边框裁剪   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ DOM匹配引擎  │  │ 模板管理引擎 │  │ 预览校准引擎 │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • 元素定位  │  │ • 模板存储   │  │ • 实时预览   │  │   │
│  │  │ • 容错匹配  │  │ • 模板复用   │  │ • 手动微调   │  │   │
│  │  │ • 相似度计算│  │ • 跨页适配   │  │ • 差异对比   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  技术栈: Python + OpenCV + Pillow + NumPy                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**API接口**:

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/vision/analyze` | POST | 分析截图标记，返回DOM映射 |
| `/api/v1/vision/preview` | POST | 生成标记预览 |
| `/api/v1/vision/calibrate` | POST | 坐标校准 |
| `/api/v1/vision/template/save` | POST | 保存标记模板 |
| `/api/v1/vision/template/list` | GET | 获取模板列表 |

### 3.2 Data Service (数据服务)

**职责**: 数据提取、API抓包、字段映射

```
┌─────────────────────────────────────────────────────────────────┐
│                      Data Service                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: URL + DOM选择器/坐标                                      │
│  输出: 提取的结构化数据                                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    核心功能模块                          │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ HTML提取引擎 │  │ API抓包引擎  │  │ 字段映射引擎 │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • XPath生成 │  │ • 请求拦截   │  │ • 值匹配     │  │   │
│  │  │ • CSS选择器 │  │ • 协议过滤   │  │ • 语义匹配   │  │   │
│  │  │ • 结构化提取│  │ • 抓包还原   │  │ • 智能推断   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 渲染引擎     │  │ 鉴权引擎     │  │ 校验引擎     │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • SSR支持   │  │ • Cookie管理 │  │ • 格式校验   │  │   │
│  │  │ • CSR等待   │  │ • Token处理  │  │ • 一致性校验 │  │   │
│  │  │ • 混合渲染  │  │ • 会话保持   │  │ • 自定义规则 │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  技术栈: Python + Selenium/Playwright + BeautifulSoup + lxml     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**API接口**:

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/data/extract/html` | POST | 从HTML提取数据 |
| `/api/v1/data/extract/api` | POST | 从API提取数据 |
| `/api/v1/data/extract/auto` | POST | 自动判断并提取 |
| `/api/v1/data/validate` | POST | 数据校验 |
| `/api/v1/data/export` | POST | 导出数据 |

### 3.3 Task Service (任务服务)

**职责**: 任务调度、批量处理、定时任务

```
┌─────────────────────────────────────────────────────────────────┐
│                      Task Service                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    任务调度引擎                          │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 调度器       │  │ 队列管理     │  │ 执行器       │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • Cron调度  │  │ • RabbitMQ   │  │ • Celery     │  │   │
│  │  │ • 事件驱动  │  │ • Redis队列  │  │ • Worker池   │  │   │
│  │  │ • 优先级    │  │ • 死信处理   │  │ • 重试机制   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    执行策略                              │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 批量处理     │  │ 定时任务     │  │ 增量更新     │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • 并发控制  │  │ • Cron表达式 │  │ • 变化检测   │  │   │
│  │  │ • 分片处理  │  │ • 日程管理   │  │ • 去重机制   │  │   │
│  │  │ • 进度跟踪  │  │ • 时区支持   │  │ • 版本对比   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  技术栈: Python + Celery + RabbitMQ/Redis                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**API接口**:

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/task/create` | POST | 创建任务 |
| `/api/v1/task/batch` | POST | 批量创建任务 |
| `/api/v1/task/schedule` | POST | 创建定时任务 |
| `/api/v1/task/status/:id` | GET | 获取任务状态 |
| `/api/v1/task/cancel/:id` | POST | 取消任务 |

### 3.4 User Service (用户服务)

**职责**: 用户管理、认证授权、权限控制

```
┌─────────────────────────────────────────────────────────────────┐
│                      User Service                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    认证授权模块                          │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 身份认证     │  │ 权限控制     │  │ 会话管理     │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • JWT令牌   │  │ • RBAC模型   │  │ • 会话存储   │  │   │
│  │  │ • OAuth2    │  │ • 资源权限   │  │ • 单点登录   │  │   │
│  │  │ • 多因素认证│  │ • 操作权限   │  │ • 在线状态   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    用户管理模块                          │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 用户CRUD     │  │ 组织管理     │  │ 配额管理     │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • 注册登录   │  │ • 团队空间   │  │ • 使用配额   │  │   │
│  │  │ • 个人信息   │  │ • 成员管理   │  │ • 计费统计   │  │   │
│  │  │ • 密码管理   │  │ • 角色分配   │  │ • 限流策略   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  技术栈: Python + FastAPI + SQLAlchemy + Redis                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**API接口**:

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/auth/login` | POST | 用户登录 |
| `/api/v1/auth/logout` | POST | 用户登出 |
| `/api/v1/user/profile` | GET | 获取用户信息 |
| `/api/v1/user/quota` | GET | 获取用户配额 |
| `/api/v1/organization/members` | GET | 获取组织成员 |

### 3.5 Extraction Engine (提取引擎)

**职责**: 核心数据提取逻辑，浏览器驱动

```
┌─────────────────────────────────────────────────────────────────┐
│                   Extraction Engine                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    浏览器池                              │   │
│  │                                                         │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │
│  │  │Browser 1│ │Browser 2│ │Browser 3│ │Browser N│ ...   │   │
│  │  │(Chrome) │ │(Firefox)│ │(Chrome) │ │(Chrome) │       │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │   │
│  │                                                         │   │
│  │  • 连接池管理  • 健康检查  • 自动重启  • 代理支持      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    驱动适配层                            │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ Selenium     │  │ Playwright   │  │ Puppeteer    │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • Chrome/Firefox│ • Chromium  │  │ • Chromium   │  │   │
│  │  │ • 成熟稳定    │  │ • 现代API   │  │ • 轻量快速   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    拦截与采集层                          │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 网络拦截     │  │ DOM监控      │  │ 性能监控     │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • API请求   │  │ • 元素变化   │  │ • 加载时间   │  │   │
│  │  │ • 响应捕获  │  │ • 事件监听   │  │ • 资源统计   │  │   │
│  │  │ • Cookie管理 │  │ • 快照对比   │  │ • 错误追踪   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.6 Scheduler Service (调度服务)

**职责**: 定时任务管理、Cron调度、任务编排

```
┌─────────────────────────────────────────────────────────────────┐
│                   Scheduler Service                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    调度引擎                              │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ Cron调度器   │  │ 事件调度器   │  │ 依赖调度器   │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • Cron表达式 │  │ • 触发器     │  │ • DAG编排    │  │   │
│  │  │ • 时区支持   │  │ • Webhook    │  │ • 前置依赖   │  │   │
│  │  │ • 日历排除   │  │ • 消息驱动   │  │ • 并行控制   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    任务管理                              │   │
│  │                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ 任务定义     │  │ 执行监控     │  │ 失败处理     │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ • 模板管理   │  │ • 实时状态   │  │ • 自动重试   │  │   │
│  │  │ • 参数配置   │  │ • 进度跟踪   │  │ • 告警通知   │  │   │
│  │  │ • 版本管理   │  │ • 日志聚合   │  │ • 人工干预   │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  技术栈: Python + APScheduler + Celery Beat                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 数据架构

### 4.1 数据流架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CrawlerX 数据流                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户操作                                                                    │
│     │                                                                      │
│     ▼                                                                      │
│  ┌──────────────┐                                                         │
│  │ 上传截图+URL │                                                         │
│  │ 标记目标位置 │                                                         │
│  └──────────────┘                                                         │
│     │                                                                      │
│     ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据采集阶段                                  │   │
│  │                                                                     │   │
│  │  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐      │   │
│  │  │ Vision Svc   │──────▶│ Data Svc     │──────▶│ Extract Engine│      │   │
│  │  │ 坐标映射     │      │ 抓包分析     │      │ 数据提取      │      │   │
│  │  └──────────────┘      └──────────────┘      └──────────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│     │                        │                        │                    │
│     ▼                        ▼                        ▼                    │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐            │
│  │ DOM映射结果  │      │ API接口数据  │      │ 提取结果     │            │
│  └──────────────┘      └──────────────┘      └──────────────┘            │
│     │                        │                        │                    │
│     └────────────────────────┴────────────────────────┘                    │
│                               │                                            │
│                               ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据处理阶段                                  │   │
│  │                                                                     │   │
│  │  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐      │   │
│  │  │ 字段映射     │──────▶│ 数据校验     │──────▶│ 数据清洗     │      │   │
│  │  │ 结构转换     │      │ 格式验证     │      │ 去重聚合     │      │   │
│  │  └──────────────┘      └──────────────┘      └──────────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                            │
│                               ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据存储阶段                                  │   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ PostgreSQL  │  │    Redis     │  │    MinIO     │              │   │
│  │  │ 结构化数据   │  │  缓存/队列   │  │  文件存储     │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                            │
│                               ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据应用阶段                                  │   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ 结果返回     │  │ 数据导出     │  │ 报表分析     │              │   │
│  │  │ API响应      │  │ Excel/CSV    │  │ 可视化看板   │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 数据模型层次

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据模型层次结构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 1: 原始数据层 (Raw Data)                          │   │
│  │                                                         │   │
│  │  • 截图文件 (image_store)                               │   │
│  │  • 网页HTML (page_html)                                 │   │
│  │  • API响应 (api_response)                               │   │
│  │  • 网络日志 (network_logs)                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 2: 处理数据层 (Processed Data)                    │   │
│  │                                                         │   │
│  │  • 标记映射 (marker_mapping)                             │   │
│  │  • DOM选择器 (dom_selector)                              │   │
│  │  • 字段映射 (field_mapping)                              │   │
│  │  • 提取规则 (extraction_rule)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 3: 结果数据层 (Result Data)                       │   │
│  │                                                         │   │
│  │  • 提取结果 (extraction_result)                         │   │
│  │  • 任务记录 (task_record)                               │   │
│  │  • 统计数据 (statistics)                                │   │
│  │  • 历史版本 (data_version)                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 4: 聚合数据层 (Aggregated Data)                   │   │
│  │                                                         │   │
│  │  • 用户统计 (user_statistics)                           │   │
│  │  • 系统指标 (system_metrics)                            │   │
│  │  • 质量报告 (quality_report)                            │   │
│  │  • 趋势分析 (trend_analysis)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 接口设计

### 5.1 RESTful API 规范

**基础规范**:

```
协议: HTTPS
版本: /api/v1/
格式: JSON
编码: UTF-8
认证: JWT Bearer Token
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1700000000,
  "request_id": "uuid"
}
```

**错误码**:

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器内部错误 |
| 503 | 服务暂不可用 |

### 5.2 核心 API 列表

#### Vision Service API

```
POST   /api/v1/vision/analyze
       分析截图标记，返回DOM映射

Request:
{
  "url": "https://example.com",
  "screenshot": "base64_encoded_image",
  "markers": [
    {"id": "m1", "x": 100, "y": 200, "width": 50, "height": 30}
  ]
}

Response:
{
  "code": 200,
  "data": {
    "mappings": [
      {
        "marker_id": "m1",
        "selector": "//div[@class='price']",
        "confidence": 0.95
      }
    ]
  }
}
```

#### Data Service API

```
POST   /api/v1/data/extract
       提取数据

Request:
{
  "url": "https://example.com",
  "selectors": [
    {"id": "price", "xpath": "//div[@class='price']"}
  ],
  "options": {
    "wait_for_load": true,
    "capture_api": true
  }
}

Response:
{
  "code": 200,
  "data": {
    "results": [
      {"id": "price", "value": "$99.99", "source": "html"}
    ],
    "apis_captured": [
      {"url": "https://api.example.com/product", "method": "GET"}
    ]
  }
}
```

#### Task Service API

```
POST   /api/v1/task/create
       创建提取任务

Request:
{
  "name": "批量商品价格提取",
  "type": "batch",
  "config": {
    "urls": ["url1", "url2"],
    "markers": [...],
    "schedule": "0 0 * * *"
  }
}

Response:
{
  "code": 200,
  "data": {
    "task_id": "task_123",
    "status": "pending"
  }
}
```

---

## 6. 安全架构

### 6.1 安全层次

```
┌─────────────────────────────────────────────────────────────────┐
│                       安全防护层次                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  网络安全层                                                │   │
│  │  • HTTPS/TLS 1.3  • DDoS防护  • WAF防火墙                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  认证授权层                                                │   │
│  │  • JWT认证  • OAuth2  • RBAC权限  • API密钥             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  数据安全层                                                │   │
│  │  • 传输加密  • 存储加密  • 敏感脱敏  • 密钥轮换          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  应用安全层                                                │   │
│  │  • SQL注入防护  • XSS防护  • CSRF防护  • 输入验证        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  审计监控层                                                │   │
│  │  • 操作审计  • 异常检测  • 行为分析  • 告警响应          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 认证流程

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│     Client   │       │   Gateway    │       │  User Service│
└──────────────┘       └──────────────┘       └──────────────┘
       │                      │                       │
       │  1. Login(username, password)              │
       │─────────────────────▶│─────────────────────▶│
       │                      │                       │
       │                      │   2. Validate user    │
       │                      ││─────────────────────▶│
       │                      │                       │
       │                      │   3. User data + role │
       │                      ││◀─────────────────────│
       │                      │                       │
       │                      │   4. Generate JWT     │
       │                      ││─────────────────────▶│
       │                      │                       │
       │   5. JWT token        │                       │
       │◀─────────────────────││◀─────────────────────│
       │                      │                       │
       │  6. API call (Bearer token)                 │
       │─────────────────────▶│                       │
       │                      │                       │
       │                      │   7. Verify JWT       │
       │                      ││─────────────────────▶│
       │                      │                       │
       │                      │   8. Token valid      │
       │                      ││◀─────────────────────│
       │                      │                       │
       │   9. Forward request  │                       │
       │◀─────────────────────│                       │
       │                      │                       │
```

---

## 7. 监控与运维

### 7.1 监控体系

```
┌─────────────────────────────────────────────────────────────────┐
│                        监控体系架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  指标采集层                                                │   │
│  │                                                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │   │
│  │  │ Prometheus│  │ Grafana  │  │ Jaeger   │  │ ELK Stack│ │   │
│  │  │ (Metrics) │  │ (Dash)   │  │ (Trace)  │  │ (Logs)   │ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                       │
│                          ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  告警处理层                                                │   │
│  │                                                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ AlertMgr │  │ PagerDuty│  │ Webhook  │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 核心监控指标

| 类别 | 指标 | 阈值 |
|------|------|------|
| **系统** | CPU使用率 | > 80% |
| **系统** | 内存使用率 | > 85% |
| **系统** | 磁盘使用率 | > 90% |
| **服务** | API响应时间 | P95 > 1s |
| **服务** | 错误率 | > 5% |
| **服务** | QPS | > 1000 |
| **业务** | 提取成功率 | < 95% |
| **业务** | 任务队列积压 | > 1000 |

---

## 8. 部署方案

### 8.1 Docker Compose 部署 (开发环境)

```yaml
version: '3.8'

services:
  # API Gateway
  gateway:
    image: kong:latest
    ports:
      - "8000:8000"

  # Vision Service
  vision-service:
    build: ./services/vision
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://redis:6379

  # Data Service
  data-service:
    build: ./services/data
    ports:
      - "8002:8000"

  # Task Service
  task-service:
    build: ./services/task
    ports:
      - "8003:8000"

  # Celery Worker
  worker:
    build: ./workers
    depends_on:
      - rabbitmq
      - redis

  # PostgreSQL
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=crawlerx
      - POSTGRES_USER=crawlerx
      - POSTGRES_PASSWORD=password

  # Redis
  redis:
    image: redis:7-alpine

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management

  # MinIO
  minio:
    image: minio/minio
    command: server /data

  # Web UI
  web:
    build: ./web
    ports:
      - "3000:3000"
```

### 8.2 Kubernetes 部署 (生产环境)

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crawlerx-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: crawlerx-api
  template:
    metadata:
      labels:
        app: crawlerx-api
    spec:
      containers:
      - name: api
        image: crawlerx/api:latest
        ports:
        - containerPort: 8000
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: crawlerx-api-service
spec:
  selector:
    app: crawlerx-api
  ports:
  - port: 8000
  type: LoadBalancer
```

---

## 9. 扩展性设计

### 9.1 水平扩展

```
┌─────────────────────────────────────────────────────────────────┐
│                      水平扩展架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Load Balancer                                                   │
│       │                                                          │
│       ├───────────────────────────────────────────────────┐     │
│       │                                                   │     │
│       ▼                                                   ▼     │
│  ┌─────────┐                                         ┌─────────┐│
│  │ Pod 1   │                                         │ Pod N   ││
│  │         │     ...        (Stateless)              │         ││
│  │ Service │                                         │ Service ││
│  └─────────┘                                         └─────────┘│
│       │                                                   │     │
│       └───────────────────────────────────────────────────┘     │
│                           │                                       │
│                           ▼                                       │
│                    Shared Storage                                 │
│                    (Redis + PostgreSQL)                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 插件扩展

```python
# 插件接口定义
class ExtractionPlugin:
    """数据提取插件基类"""

    def pre_extract(self, context: ExtractionContext) -> None:
        """提取前钩子"""
        pass

    def post_extract(self, data: ExtractedData) -> ExtractedData:
        """提取后钩子"""
        pass

    def on_error(self, error: Exception) -> None:
        """错误处理钩子"""
        pass

# 示例插件
class DataEncryptionPlugin(ExtractionPlugin):
    def post_extract(self, data):
        for field in data.fields:
            if field.is_sensitive:
                field.value = self.encrypt(field.value)
        return data
```

---

## 10. 技术债务与优化

### 10.1 已知限制

| 限制项 | 影响 | 优化计划 |
|--------|------|----------|
| 大文件处理 | >10MB截图处理慢 | 流式处理优化 |
| 复杂动态页面 | 某些SPA提取失败 | AI模型增强 |
| 并发限制 | 单机1000并发上限 | 分布式扩展 |
| 依赖浏览器 | 资源占用高 | 无头模式优化 |

### 10.2 优化方向

| 优化项 | 当前状态 | 目标状态 |
|--------|----------|----------|
| 响应时间 | 平均3s | <1s |
| 准确率 | 92% | >98% |
| 资源占用 | 2GB/实例 | <500MB |
| 并发能力 | 1000 | 10000+ |

---

## 11. 附录

### 11.1 技术选型对比

| 组件 | 方案A | 方案B | 选择 | 理由 |
|------|-------|-------|------|------|
| 前端框架 | React | Vue | React | 生态更成熟 |
| 后端框架 | FastAPI | Flask | FastAPI | 性能更好 |
| 浏览器驱动 | Selenium | Playwright | Selenium | 稳定性高 |
| 数据库 | PostgreSQL (统一) | PostgreSQL+Redis+MinIO+MongoDB | PostgreSQL (统一) | 简化运维、ACID事务 |
| 任务队列 | PostgreSQL (SKIP LOCKED) | Redis | PostgreSQL | 事务一致性 |

### 11.2 参考文档

| 文档 | 链接 |
|------|------|
| 系统需求文档 | `./01-SRD_System_Requirements_Document.md` |
| 数据库设计文档 | `./03-DDD_Database_Design_Document.md` |
| 任务规划文档 | `./04-TPD_Task_Planning_Document.md` |

---

**文档变更记录**

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2025-12-25 | 初始版本 | AI System Architect |
| v2.0.0 | 2025-12-25 | 统一PostgreSQL存储策略，更新架构图 | AI System Architect |

---

*本文档定义了 CrawlerX 系统的完整技术架构，包括逻辑架构、部署架构、服务设计、接口设计、安全架构等，为系统实施提供技术指导。*

---

### 参考文档更新

| 文档 | 链接 |
|------|------|
| 系统需求文档 | `./01-SRD_System_Requirements_Document.md` |
| 数据库设计文档 | `./03-DDD_Database_Design_Document.md` (v2.0.0 - 统一PostgreSQL) |
| 任务规划文档 | `./04-TPD_Task_Planning_Document.md` |
| 存储策略文档 | `./05-PostgreSQL_Storage_Strategy.md` |
